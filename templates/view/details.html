{% extends "view/base.html" %}


{% block content %}
<div class="content-body">
	<div class="container">
		<div class="row">
			<main class="col-md-12">
				<article class="post post-1">
					<header class="entry-header">
						<h1 class="entry-title">{{ blogInfo.title }}</h1>
						<div class="entry-meta">
							<span class="post-date">{{ blogInfo.publish_time }}</span>
							<span class="views-count">{{ blogInfo.read_count }} 阅读</span>
						</div>
					</header>
					<div class="entry-content clearfix" style="border: 1px saddlebrown">
						{{ details | safe }}
					</div>
				</article>
				<span class="comment-area" id="comment-area">
					<hr>
					<h3>发表评论</h3>
					<form class="comment-form" id="myForm">
						<div class="row">
							<div class="col-md-4">
								<label for="name">名字：</label>
								<input type="text" id="name" style="border-radius: 5px" name="name" required>
							</div>
							<div class="col-md-4">
								<label for="id_email" >邮箱：</label>
								<input type="text" id="id_email" style="border-radius: 5px" name="email" required>
							</div>
							<div class="col-md-4">
								<label for="id_url" >网址：</label>
								<input type="text" id="id_url" style="border-radius: 5px" name="url" required>
							</div>
							<div class="col-md-12">
								<label for="comment">评论：</label>
								<textarea name="comment" style="border-radius: 5px" id="comment" required></textarea>
								<button type="button" class="comment-btn" onclick="save()">发表</button>
							</div>
						</div>    <!-- row -->
					</form>
					<div class="comment-list-panel">
						<h3>评论列表，共 <span id="commentCount">0</span> 条评论</h3>
						<ul class="comment-list list-unstyled" id="commentList">
						</ul>
					</div>
				</span>
			</main>
		</div>
	</div>
</div>
{% endblock content %}

{% block script %}
<script type="text/javascript" src="/static/js/jsonUtil.js"></script>
<script type="text/javascript" src="/static/js/layer.js"></script>


<script>
	$(document).ready(function () {
		$.fn.yestop({
			"yes_image": "",
			"yes_radius": "30%",
			"yes_html": "Top&#8593;",
			"yes_backColor":"#f1ecec",
			"yes_hoverHtml":"Go Top"
		});
	})


	$(() => {
		getComments()
	})

	function notNull(json) {
		for (let jsonKey in json) {
			let lab = $('label[for='+ jsonKey +']').text();
			if (lab) {
				if (!json[jsonKey]) {
					layer.msg(lab + "不能为空")
					return false
				}
			}
		}
		return true
	}

	function save() {
		let json = $('form').toJson()
		if (notNull(json)) {
			json.blog_id = '{{ blogInfo.id }}'
			$.ajax({
				url: "/blog/comment/save",
				data: json,
				type: "post",
				dataType: "json",
				async: false,
				success: function (result) {
					if (result.code === 500) {
						layer.msg(result.msg, {icon: 2});
					} else {
						layer.msg(result.msg, {icon: 1});
					}
					document.getElementById("myForm").reset();
					getComments()
				},
			})
		}
	}


	function getComments() {
		let html_str = ""
		$.ajax({
			url: "/blog/comment/{{ blogInfo.id }}",
			type: "get",
			dataType: "json",
			async: false,
			success: function (result) {
				let data = result.data;
				$('#commentCount').text(data.length)
				for (let d of data) {
					html_str = html_str.concat(`
						<li class="comment-item">
						<span class="nickname">${d.name}</span>
						<time class="submit-date">${d.create_time}</time>
						<div class="text">
							${d.comment}
						</div>
						</li>
					`)
				}
			},
		})
		$('#commentList').html(html_str)
	}

</script>
{% endblock script %}